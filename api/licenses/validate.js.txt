// Ubicación de este archivo: /api/licenses/validate.js
const jwt = require('jsonwebtoken');

// --- Clave Secreta para firmar JWT ---
// Vercel inyecta las variables de entorno automáticamente.
const JWT_SECRET = process.env.JWT_SECRET || 'clave-super-secreta-para-produccion-cambiar-esto';

// --- Base de Datos Falsa de Licencias ---
const validLicenses = {
  'TALLERPRO-VALIDA-1234-5678': { used: false, domain: null, type: 'PRO_LIFETIME' },
  'TALLERPRO-ANUAL-ABCD-EFGH': { used: false, domain: null, type: 'PRO_YEARLY' },
};

// Esta es la función serverless que Vercel ejecutará.
module.exports = (req, res) => {
  // --- Configuración Manual de CORS ---
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

  // Manejo de la Petición Pre-vuelo (Preflight)
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  // Solo aceptamos peticiones POST.
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return res.status(405).end(`Method ${req.method} Not Allowed`);
  }
  
  // --- LOGS DE DIAGNÓSTICO ---
  console.log('--- Petición recibida en /api/licenses/validate.js ---');
  console.log('Cuerpo de la petición:', req.body);

  const { licenseKey, uuid, domain } = req.body;

  if (!licenseKey || !uuid || !domain) {
    return res.status(400).json({ message: 'Faltan datos requeridos.' });
  }
  
  const license = validLicenses[licenseKey];

  if (!license) {
    return res.status(404).json({ message: 'La clave de licencia no es válida.' });
  }
  
  // ... resto de la lógica de validación ...
  const expiration = license.type === 'PRO_YEARLY' ? '365d' : '10y';
  const tokenPayload = { uuid, domain, type: license.type };
  const token = jwt.sign(tokenPayload, JWT_SECRET, { expiresIn: expiration });

  return res.status(200).json({
    message: 'Licencia activada con éxito.',
    token,
  });
};
